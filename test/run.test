#! /usr/bin/env bash
#
# Match what c-cpp.yml does to run standalone here.

# Usage: ./oifs_43r3_1.00_x86_64-pc-linux-gnu-debug <start_date> <exptid> <unique_member_id> <batchid> <wuid> <fclen> <app_name> <nthreads> [app_version]

# First run setup_test.py in the 'test' directory.

set -x
set -e

# put control code exe into projects
cp ../oifs_43r3_1.00_x86_64-pc-linux-gnu-debug projects


cd slots/0

FCLEN=24      # length of forecast in hours

[ -f stderr.txt ] && /bin/rm stderr.txt

# copy test app executable and link it to the expected name.
# this will change when we set the app name as input to the controller.
cp ../../../test_model.exe .
[ -f oifs_43r3_test.exe ] && /bin/rm oifs_43r3_test.exe
ln -s test_model.exe   oifs_43r3_test.exe


# adjust input file names
# by default the test_setup.py creates a 1hr run, but this script is set to run 24hrs.
if [ ! -f oifs_43r3_NNNN_yyyymmddhh_24_d000_0.zip ]; then
   cp oifs_43r3_NNNN_yyyymmddhh_1_d000_0.zip oifs_43r3_NNNN_yyyymmddhh_${FCLEN}_d000_0.zip
fi

# run model
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${HOME}/github/boinc-8.0.2-x86_64/lib

../../projects/oifs_43r3_1.00_x86_64-pc-linux-gnu-debug yyyymmddhh EXPT NNNN d000 0 ${FCLEN} oifs_43r3 1 1.00 0

set +x 
